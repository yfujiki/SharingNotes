# SOP: Running Supabase CLI migrations

Keeping database changes in sync requires the Supabase CLI. Recent CLI versions deprecate `shadow_db_url`; use explicit connection strings per command instead.

## Prerequisites
- Supabase CLI installed (`brew install supabase/tap/supabase` or follow official docs).
- Project ref (`project_id`) stored in `supabase/config.toml` (fixed to `jsqalwkuikuvonjmgejh` for this project).
- Supabase project password (service role password from Dashboard → Settings → Database → Password).

## Local development
1. Start the local stack (only when using `supabase start`):
   ```bash
   supabase start
   ```
   This provisions local Postgres/Realtime/etc. Use `supabase stop` to tear down.

2. Point the app to the local stack by updating `.env.local` with the values printed by `supabase start` (typically `http://127.0.0.1:54321` for `NEXT_PUBLIC_SUPABASE_URL` and the anon/service-role keys from the local dashboard). Restore production credentials before deploying.

3. Create a new migration:
   ```bash
   supabase migration new add_example_table
   ```
   Edit the SQL file under `supabase/migrations/<timestamp>_add_example_table.sql`.

4. Apply migrations to your local stack:
   ```bash
   supabase db push
   ```
   - Behind the scenes the CLI connects using the credentials from `supabase/.temp/` generated by `supabase start`.

## Remote database (Supabase hosted)
The CLI no longer accepts `shadow_db_url`. Instead, pass the connection string explicitly.

- Promote local migrations to the remote project:
  ```bash
  supabase db push --db-url "postgresql://postgres:<SUPABASE_PASSWORD>@db.jsqalwkuikuvonjmgejh.supabase.co:5432/postgres"
  ```

- Reset the remote database (destroys data!)
  ```bash
  supabase db reset --db-url "postgresql://postgres:<SUPABASE_PASSWORD>@db.jsqalwkuikuvonjmgejh.supabase.co:5432/postgres"
  ```

Replace `<SUPABASE_PASSWORD>` with the Supabase project password. If the password contains special characters, escape them (e.g., `\@`) or wrap the entire URL in single quotes. The connection string must target the primary database; add query params as needed (`?sslmode=require`).

## Validation steps
- After applying migrations, connect via `supabase sql` or the dashboard editor to confirm tables/policies exist.
- Run application smoke tests (`pnpm dev`, `/check` page) to ensure new schema aligns with code expectations.

## Related Docs
- `AGENTS.md` – Architecture overview and directory structure.
- `Strategies/issue-2.md` – Notes domain schema plan.
- Supabase CLI reference: https://supabase.com/docs/guides/cli
